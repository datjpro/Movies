@model List<ApplicationUser>
@{
    ViewData["Title"] = "Qu·∫£n l√Ω Users";
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">
            <i class="fas fa-users me-2"></i>
            Qu·∫£n l√Ω Users
        </h1>
        <a asp-action="Index" class="btn btn-secondary">
            <i class="fas fa-arrow-left me-2"></i>
            Quay l·∫°i Dashboard
        </a>
    </div>

    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                Danh s√°ch Users (@ViewBag.TotalUsers)
            </h5>
        </div>
        <div class="card-body">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Avatar</th>
                                <th>Th√¥ng tin</th>
                                <th>Ng√†y t·∫°o</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>Thao t√°c</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in Model)
                            {
                                <tr>
                                    <td>
                                        <div class="rounded-circle bg-primary text-white d-flex align-items-center justify-content-center" 
                                             style="width: 50px; height: 50px; font-size: 20px; font-weight: bold;">
                                            @user.FullName.Substring(0, 1).ToUpper()
                                        </div>
                                    </td>
                                    <td>
                                        <div>
                                            <strong>@user.FullName</strong>
                                        </div>
                                        <div class="text-muted">@user.Email</div>
                                        @if (!string.IsNullOrEmpty(user.PhoneNumber))
                                        {
                                            <div class="text-muted small">üìû @user.PhoneNumber</div>
                                        }
                                    </td>
                                    <td>
                                        @user.CreatedAt.ToString("dd/MM/yyyy HH:mm")
                                    </td>
                                    <td>
                                        <div class="d-flex flex-column">
                                            <span class="badge bg-@(user.IsActive ? "success" : "secondary") mb-1">
                                                @(user.IsActive ? "Ho·∫°t ƒë·ªông" : "T·∫°m kh√≥a")
                                            </span>
                                            @if (user.EmailConfirmed)
                                            {
                                                <span class="badge bg-success">Email x√°c th·ª±c</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-warning">Ch∆∞a x√°c th·ª±c</span>
                                            }
                                        </div>
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-sm btn-outline-@(user.IsActive ? "warning" : "success")" 
                                                    onclick="toggleUserStatus('@user.Id', @user.IsActive.ToString().ToLower())"
                                                    title="@(user.IsActive ? "Kh√≥a t√†i kho·∫£n" : "K√≠ch ho·∫°t t√†i kho·∫£n")">
                                                <i class="fas fa-@(user.IsActive ? "lock" : "unlock")"></i>
                                            </button>
                                            
                                            @if (user.Email != User.Identity.Name)
                                            {
                                                <button class="btn btn-sm btn-outline-danger" 
                                                        onclick="deleteUser('@user.Id', '@user.FullName')" 
                                                        title="X√≥a t√†i kho·∫£n">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>                <!-- Pagination -->
                @if (ViewBag.TotalPages > 1)
                {                    <div class="d-flex justify-content-between align-items-center mt-4">
                        <div class="text-muted">
                            Hi·ªÉn th·ªã @((ViewBag.CurrentPage - 1) * 10 + 1) - @(Math.Min(ViewBag.CurrentPage * 10, (int)ViewBag.TotalUsers)) 
                            trong t·ªïng s·ªë @ViewBag.TotalUsers ng∆∞·ªùi d√πng
                        </div>
                        <nav aria-label="Ph√¢n trang ng∆∞·ªùi d√πng">
                            <ul class="pagination mb-0">
                                @if (ViewBag.CurrentPage > 1)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="@Url.Action("Users", new { page = 1 })" 
                                           title="Trang ƒë·∫ßu">
                                            <i class="fas fa-angle-double-left"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="@Url.Action("Users", new { page = ViewBag.CurrentPage - 1 })" 
                                           title="Trang tr∆∞·ªõc">
                                            <i class="fas fa-angle-left"></i>
                                        </a>
                                    </li>
                                }

                                @{
                                    int startPage = Math.Max(1, ViewBag.CurrentPage - 2);
                                    int endPage = Math.Min(ViewBag.TotalPages, ViewBag.CurrentPage + 2);
                                    
                                    if (endPage - startPage < 4 && ViewBag.TotalPages > 4)
                                    {
                                        if (startPage == 1)
                                            endPage = Math.Min(ViewBag.TotalPages, startPage + 4);
                                        else if (endPage == ViewBag.TotalPages)
                                            startPage = Math.Max(1, endPage - 4);
                                    }
                                }

                                @for (int i = startPage; i <= endPage; i++)
                                {
                                    <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                                        <a class="page-link" href="@Url.Action("Users", new { page = i })">
                                            @i
                                        </a>
                                    </li>
                                }

                                @if (ViewBag.CurrentPage < ViewBag.TotalPages)
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="@Url.Action("Users", new { page = ViewBag.CurrentPage + 1 })" 
                                           title="Trang sau">
                                            <i class="fas fa-angle-right"></i>
                                        </a>
                                    </li>
                                    <li class="page-item">
                                        <a class="page-link" href="@Url.Action("Users", new { page = ViewBag.TotalPages })" 
                                           title="Trang cu·ªëi">
                                            <i class="fas fa-angle-double-right"></i>
                                        </a>
                                    </li>
                                }
                            </ul>
                        </nav>
                    </div>
                }
            }
            else
            {
                <div class="text-center py-4">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <h5>Kh√¥ng c√≥ user n√†o</h5>
                </div>
            }
        </div>
    </div>
</div>

<script>
function toggleUserStatus(userId, currentStatus) {
    const action = currentStatus ? 'kh√≥a' : 'm·ªü kh√≥a';
    if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ${action} t√†i kho·∫£n n√†y?`)) {
        fetch('@Url.Action("ToggleUserStatus")', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
            },
            body: JSON.stringify({ userId: userId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('C√≥ l·ªói x·∫£y ra');
            }
        });
    }
}

function deleteUser(userId, userName) {
    if (confirm(`B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a t√†i kho·∫£n "${userName}"? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.`)) {
        // Implementation for delete user
        alert('T√≠nh nƒÉng x√≥a user ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn');
    }
}
</script>
