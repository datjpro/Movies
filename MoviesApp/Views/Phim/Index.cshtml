@model IEnumerable<MoviesApp.Models.Phim>

@{
    ViewData["Title"] = "Danh sách Phim";
    var currentPage = ViewBag.CurrentPage ?? 1;
    var totalPages = ViewBag.TotalPages ?? 1;
    var pageSize = ViewBag.PageSize ?? 12;
    var totalItems = ViewBag.TotalItems ?? 0;
    var search = ViewBag.Search ?? "";
    var quocGia = ViewBag.QuocGia ?? "";
    var theLoai = ViewBag.TheLoai ?? "";
    var danhMuc = ViewBag.DanhMuc ?? "";
}

<div class="container mt-4">
    <!-- Header và nút thêm phim -->
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="text-primary">
                    <i class="fas fa-film me-2"></i>
                    Danh sách Phim
                </h2>
                @if (User.IsInRole("Admin"))
                {
                    <a asp-action="Create" class="btn btn-success">
                        <i class="fas fa-plus me-1"></i>
                        Thêm phim mới
                    </a>
                }
            </div>
        </div>
    </div>    <!-- Bộ lọc và tìm kiếm -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card filter-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>
                        Lọc và tìm kiếm
                    </h5>
                </div>
                <div class="card-body">
                    <form method="get" asp-action="Index">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="search" class="form-label">Tìm kiếm phim</label>
                                <input type="text" class="form-control" id="search" name="search" value="@search" placeholder="Nhập tên phim...">
                            </div>
                            <div class="col-md-3">
                                <label for="quocGia" class="form-label">Quốc gia</label>
                                <select class="form-select" id="quocGia" name="quocGia">
                                    <option value="">Tất cả quốc gia</option>
                                    @if (ViewBag.QuocGias != null)
                                    {
                                        @foreach (var qg in ViewBag.QuocGias)
                                        {
                                            <option value="@qg.MaQG" selected="@(quocGia == qg.MaQG)">@qg.TenQG</option>
                                        }
                                    }
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="theLoai" class="form-label">Thể loại</label>
                                <select class="form-select" id="theLoai" name="theLoai">
                                    <option value="">Tất cả thể loại</option>
                                    @if (ViewBag.TheLoaiPhims != null)
                                    {
                                        @foreach (var tl in ViewBag.TheLoaiPhims)
                                        {
                                            <option value="@tl.MaTL" selected="@(theLoai == tl.MaTL)">@tl.TenTL</option>
                                        }
                                    }
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="danhMuc" class="form-label">Danh mục</label>
                                <select class="form-select" id="danhMuc" name="danhMuc">
                                    <option value="">Tất cả danh mục</option>
                                    @if (ViewBag.DanhMucs != null)
                                    {
                                        @foreach (var dm in ViewBag.DanhMucs)
                                        {
                                            <option value="@dm.MaDM" selected="@(danhMuc == dm.MaDM)">@dm.TenDM</option>
                                        }
                                    }
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-search me-1"></i>
                                    Tìm kiếm
                                </button>
                                <a href="@Url.Action("Index")" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i>
                                    Xóa bộ lọc
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>    <!-- Thông tin phân trang -->
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="search-info d-flex justify-content-between align-items-center">
                <div class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Hiển thị <strong>@(((currentPage - 1) * pageSize) + 1)</strong> - <strong>@(Math.Min(currentPage * pageSize, totalItems))</strong> trong tổng số <strong>@totalItems</strong> phim
                    @if (!string.IsNullOrEmpty(search) || !string.IsNullOrEmpty(quocGia) || !string.IsNullOrEmpty(theLoai) || !string.IsNullOrEmpty(danhMuc))
                    {
                        <span class="badge bg-primary ms-2">Đã lọc</span>
                    }
                </div>
                <div class="text-muted">
                    <i class="fas fa-bookmark me-1"></i>
                    Trang <strong>@currentPage</strong> / <strong>@totalPages</strong>
                </div>
            </div>
        </div>
    </div><!-- Danh sách phim -->
    <div class="row">
        <div class="col-md-12">
            @if (Model.Any())
            {
                <div class="row">                    @foreach (var item in Model)
                    {
                        <div class="col-md-6 col-lg-4 mb-4">
                            <div class="card h-100 shadow-sm movie-card">
                                @if (!string.IsNullOrEmpty(item.AnhPhim))
                                {
                                    <img src="@item.AnhPhim" class="card-img-top" alt="@item.TenPhim" style="height: 300px; object-fit: cover;">
                                }
                                else
                                {
                                    <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 300px;">
                                        <i class="fas fa-image fa-3x text-muted"></i>
                                    </div>
                                }
                                
                                <div class="card-body d-flex flex-column">
                                    <h5 class="card-title text-truncate" title="@item.TenPhim">@item.TenPhim</h5>
                                    
                                    <div class="mb-2">
                                        <small class="text-muted">
                                            <strong>Thể loại:</strong> @item.TheLoaiPhim?.TenTL<br>
                                            <strong>Quốc gia:</strong> @item.QuocGia?.TenQG<br>
                                            <strong>Danh mục:</strong> @item.DanhMuc?.TenDM<br>
                                            <strong>Năm:</strong> @item.NamPhatHanh<br>
                                            <strong>Số tập:</strong> @item.SoTap<br>
                                            @if (item.ThongKePhim != null)
                                            {
                                                <strong>Lượt xem:</strong> @item.ThongKePhim.TongLuotXem.ToString("N0")<br>
                                                <strong>Điểm:</strong> @item.ThongKePhim.DiemTrungBinh.ToString("0.0")<text>/10</text>
                                            }
                                        </small>
                                    </div>
                                    
                                    @if (!string.IsNullOrEmpty(item.MoTaPhim))
                                    {
                                        <p class="card-text flex-grow-1">
                                            @(item.MoTaPhim.Length > 100 ? item.MoTaPhim.Substring(0, 100) + "..." : item.MoTaPhim)
                                        </p>
                                    }
                                    
                                    <div class="mt-auto">
                                        <div class="btn-group w-100 btn-group-actions" role="group">
                                            <a asp-action="Details" asp-route-id="@item.MaPhim" class="btn btn-outline-primary btn-sm">
                                                <i class="fas fa-eye me-1"></i>Chi tiết
                                            </a>
                                            @if (User.IsInRole("Admin") || User.IsInRole("User"))
                                            {
                                                <a asp-action="Edit" asp-route-id="@item.MaPhim" class="btn btn-outline-warning btn-sm">
                                                    <i class="fas fa-edit me-1"></i>Sửa
                                                </a>
                                            }
                                            @if (User.IsInRole("Admin"))
                                            {
                                                <a asp-action="Delete" asp-route-id="@item.MaPhim" class="btn btn-outline-danger btn-sm">
                                                    <i class="fas fa-trash me-1"></i>Xóa
                                                </a>
                                            }
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="fas fa-film fa-4x text-muted mb-3"></i>
                    <h4 class="text-muted">Không tìm thấy phim nào</h4>
                    <p class="text-muted">
                        @if (!string.IsNullOrEmpty(search) || !string.IsNullOrEmpty(quocGia) || !string.IsNullOrEmpty(theLoai) || !string.IsNullOrEmpty(danhMuc))
                        {
                            <span>Hãy thử thay đổi bộ lọc hoặc từ khóa tìm kiếm!</span>
                        }
                        else
                        {
                            <span>Hãy thêm phim đầu tiên của bạn!</span>
                        }
                    </p>
                    @if (User.IsInRole("Admin"))
                    {
                        <a asp-action="Create" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i>
                            Thêm phim mới
                        </a>
                    }
                </div>
            }
        </div>
    </div>

    <!-- Phân trang -->
    @if (totalPages > 1)
    {
        <div class="row mt-4">
            <div class="col-md-12">
                <nav aria-label="Phân trang danh sách phim">
                    <ul class="pagination justify-content-center">
                        <!-- Nút Previous -->
                        @if (currentPage > 1)
                        {
                            <li class="page-item">
                                <a class="page-link" href="@Url.Action("Index", new { page = currentPage - 1, search = search, quocGia = quocGia, theLoai = theLoai, danhMuc = danhMuc })" aria-label="Trang trước">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                        }
                        else
                        {
                            <li class="page-item disabled">
                                <span class="page-link" aria-label="Trang trước">
                                    <span aria-hidden="true">&laquo;</span>
                                </span>
                            </li>
                        }

                        <!-- Hiển thị các trang -->
                        @{
                            int startPage = Math.Max(1, currentPage - 2);
                            int endPage = Math.Min(totalPages, currentPage + 2);
                            
                            // Hiển thị trang đầu nếu cần
                            if (startPage > 1)
                            {
                                <li class="page-item">
                                    <a class="page-link" href="@Url.Action("Index", new { page = 1, search = search, quocGia = quocGia, theLoai = theLoai, danhMuc = danhMuc })">1</a>
                                </li>
                                if (startPage > 2)
                                {
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                }
                            }
                            
                            // Hiển thị các trang trong khoảng
                            for (int i = startPage; i <= endPage; i++)
                            {
                                if (i == currentPage)
                                {
                                    <li class="page-item active">
                                        <span class="page-link">@i</span>
                                    </li>
                                }
                                else
                                {
                                    <li class="page-item">
                                        <a class="page-link" href="@Url.Action("Index", new { page = i, search = search, quocGia = quocGia, theLoai = theLoai, danhMuc = danhMuc })">@i</a>
                                    </li>
                                }
                            }
                            
                            // Hiển thị trang cuối nếu cần
                            if (endPage < totalPages)
                            {
                                if (endPage < totalPages - 1)
                                {
                                    <li class="page-item disabled">
                                        <span class="page-link">...</span>
                                    </li>
                                }
                                <li class="page-item">
                                    <a class="page-link" href="@Url.Action("Index", new { page = totalPages, search = search, quocGia = quocGia, theLoai = theLoai, danhMuc = danhMuc })">@totalPages</a>
                                </li>
                            }
                        }

                        <!-- Nút Next -->
                        @if (currentPage < totalPages)
                        {
                            <li class="page-item">
                                <a class="page-link" href="@Url.Action("Index", new { page = currentPage + 1, search = search, quocGia = quocGia, theLoai = theLoai, danhMuc = danhMuc })" aria-label="Trang sau">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        }
                        else
                        {
                            <li class="page-item disabled">
                                <span class="page-link" aria-label="Trang sau">
                                    <span aria-hidden="true">&raquo;</span>
                                </span>
                            </li>
                        }
                    </ul>
                </nav>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js" crossorigin="anonymous"></script>
    <script>
        // Smooth scroll khi click pagination
        document.querySelectorAll('.pagination .page-link').forEach(link => {
            link.addEventListener('click', function(e) {
                // Add loading spinner to clicked link
                const spinner = document.createElement('span');
                spinner.className = 'loading-spinner ms-1';
                this.appendChild(spinner);
            });
        });

        // Auto submit form khi thay đổi filter
        document.querySelectorAll('#quocGia, #theLoai, #danhMuc').forEach(select => {
            select.addEventListener('change', function() {
                // Optional: Auto submit form when filter changes
                // this.form.submit();
            });
        });

        // Enter key support for search
        document.getElementById('search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                this.form.submit();
            }
        });

        // Scroll to top after page change
        if (window.location.search.includes('page=')) {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
}
